<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<title>Transactions revisited</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="ch09">Transactions revisited</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter covers</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Time-locking bitcoins</p>
</li>
<li>
<p>Swapping coins between blockchains</p>
</li>
<li>
<p>Attaching arbitrary data to transactions</p>
</li>
<li>
<p>Bumping the fee of a pending transaction</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We’re now past the core chapters of the book, in which you learned the
Bitcoin basics. In this chapter, we’ll dig deeper into the
functionality transactions can offer.</p>
</div>
<div class="paragraph">
<p>We’ll start by exploring time locks. A <em>time lock</em> is a way to make a
transaction invalid until some point in time. This means the
transaction can’t be confirmed before that time constraint
is met. Also, an output of a transaction can be programmed to prevent
it from being spent until a time constraint is fulfilled. This is
useful for digital contracts, such as atomic swaps, covered later in
this chapter.</p>
</div>
<div class="paragraph">
<p>It’s sometimes useful to store a small amount of data in a transaction
in the blockchain. For example, a car manufacturer might want to track
ownership of a car by putting its chassis number into a Bitcoin
transaction, effectively creating a token on the Bitcoin
blockchain. The current owner can then transfer ownership of the car
by sending that token to the new owner.</p>
</div>
<div class="paragraph">
<p>As mentioned in <a href="#altcoins">[altcoins]</a>, several alternative cryptocurrencies are
available. Sometimes, you might want to trade, for example, namecoins
for bitcoins. The most obvious way to do this is to use an exchange to
sell bitcoins and buy namecoins. But there are other, more
decentralized ways to do it. <em>Atomic swaps</em> let you swap bitcoins
directly with someone holding namecoins without a trusted third party,
like an exchange.</p>
</div>
<div class="paragraph">
<p>If you pay a too-small transaction fee, miners might refuse to confirm
the transaction within a reasonable time. In this situation, it can be
helpful to replace the transaction with another one that pays a little
more in fees. This is known as <em>fee-bumping</em>.</p>
</div>
<div class="paragraph">
<p>Finally, we’ll explore some intricate details of signatures. You can
create signatures in different ways depending on your use case. You
can tune what the signature should commit to: in other words, change
how the signing algorithm hashes the transaction.</p>
</div>
<div class="sect2">
<h3 id="time-locked-transactions">Time-locked transactions</h3>
<div class="paragraph">
<p>When you create and sign a transaction, it’s valid and ready for
inclusion in any future block. You can broadcast it immediately and have
it mined. This is the normal case.</p>
</div>
<div class="paragraph">
<p>But in some cases, you may want to sign a transaction with a guarantee
that it won’t be mined until after at least, say, one year has passed.</p>
</div>
<div class="paragraph">
<p>Suppose you have 100 bitcoins, and you want your daughter to inherit the
money to her address @<sub>D</sub>, but only after you die. You can create a
transaction that’s time-locked (<a href="#fig0901">A payment to your daughter that will become valid on 30 April 2019</a>).</p>
</div>
<div class="sidebarblock gbinfo">
<div class="content">
<div class="title">No fee?</div>
<div class="paragraph">
<p>For the sake of simplicity, most examples in this chapter don’t pay
any fees.</p>
</div>
</div>
</div>
<div id="fig0901" class="imageblock">
<div class="content">
<img src="images/ch09/09-01.svg" alt="{big-width}">
</div>
<div class="title">Figure 1. A payment to your daughter that will become valid on 30 April 2019</div>
</div>
<div class="sidebarblock gbinfo">
<div class="content">
<div class="title">Sequence numbers</div>
<div class="paragraph">
<p>Sequence numbers are always included in inputs, but I haven’t shown
them because they didn’t matter to the transactions used so far.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>What makes this transaction special are the inputs’ sequence numbers and
the transaction lock time. I briefly mentioned sequence numbers in
<a href="ch05-transactions.html">[ch05]</a>. They’re used to enable the lock time: if any input has a
sequence number less than <code>ffffffff</code>—for example, <code>fffffffe</code>—the lock
time set on the transaction will be effective. If all sequence numbers
are <code>ffffffff</code>, the lock time won’t have any effect.</p>
</div>
<div class="paragraph">
<p>You give this transaction, Tx<sub>1</sub>, to your daughter. It’s currently
invalid; your daughter stores it on her computer and prints a backup
that she keeps in another place. It isn’t broadcast; no full node will
accept a block containing this transaction yet. The transaction will
become valid the morning of 30 April 2019. If you die before that, your
daughter must wait until after the lock-time date and then claim the
money by broadcasting the transaction, which will have become valid by
then.</p>
</div>
<div class="paragraph">
<p>If you don’t die before that date, you want to make sure the time-locked
transaction becomes useless so your daughter can’t take the money once
the date has passed.</p>
</div>
<div class="paragraph">
<p>You can create, but not yet broadcast, a new transaction, Tx<sub>2</sub>, that
double spends an output that Tx<sub>1</sub> spends (<a href="#fig0902">Make Tx<sub>1</sub> invalid by spending an output that Tx<sub>1</sub> spends, and create a new time-locked transaction for your daughter.</a>). You then
create a new transaction, time-locked for yet another year, for your
daugher.  When she’s stored the transaction safely, you broadcast Tx2.</p>
</div>
<div id="fig0902" class="imageblock">
<div class="content">
<img src="images/ch09/09-02.svg" alt="{full-width}">
</div>
<div class="title">Figure 2. Make Tx<sub>1</sub> invalid by spending an output that Tx<sub>1</sub> spends, and create a new time-locked transaction for your daughter.</div>
</div>
<div class="sidebarblock gbinfo">
<div class="content">
<div class="title">Transaction malleability</div>
<div class="paragraph">
<p>There’s a problem here. The txid of Tx<sub>2</sub> <em>can</em> change while being
broadcast, making Tx<sub>3</sub> forever invalid. This is called <em>transaction
malleability</em> and is fixed by using segregated witness as discussed in
<a href="#ch10">[ch10]</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>You need to</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create and sign a transaction, Tx<sub>2</sub>, that spends at least one of
the outputs spent by Tx<sub>1</sub>. Tx<sub>2</sub> is a normal, not time-locked,
transaction.  Don’t broadcast this transaction just yet.</p>
</li>
<li>
<p>Create a new time-locked transaction, Tx<sub>3</sub>, that spends all your
outputs as if Tx<sub>2</sub> was confirmed. Tx<sub>3</sub> is locked for another year.<br>
Give it to your daughter.</p>
</li>
<li>
<p>Broadcast Tx<sub>2</sub>. Once Tx<sub>2</sub> is mined, Tx<sub>1</sub> will become forever
invalid because one of the inputs of Tx<sub>1</sub> is spent by Tx<sub>2</sub>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note how the order of events is important here. If Tx<sub>2</sub> is broadcast
<em>before</em> you give Tx<sub>3</sub> to your daughter, there’s a chance you’ll die
before giving her Tx<sub>3</sub>. Then, your daughter won’t be able to receive
the funds because she has no valid transaction to claim them with. Tx<sub>1</sub>
is invalidated by Tx<sub>2</sub> in the blockchain, and Tx<sub>3</sub> isn’t in your
daughter’s possession.</p>
</div>
<div class="sect3">
<h4 id="_time_measurements">Time measurements</h4>
<div class="paragraph">
<p>You can express a lock time in two ways. The first is by setting a date
and time as in the previous example. The second is to set a block
height.</p>
</div>
<div class="sect4">
<h5 id="_block_time">Block time</h5>
<div class="paragraph">
<p>The first example expressed the lock time as a date and time. This means
the <em>median time past</em> must be greater than the lock time in the
transaction. In <a href="ch07-proof-of-work.html">[ch07]</a>, I noted that a block’s timestamp must be
greater than the past 11 blocks’ median timestamp, or the <em>median time
past</em> of the block. We use the median time past to decide whether a
transaction is valid as regards the lock time. Suppose you died on 24
January 2019. Your mourning daughter wouldn’t be able to claim your
money until 30 April 2019. <a href="#fig0903">Your daughter can claim your money after the median time past is earlier than your lock time.</a> illustrates this more precisely.</p>
</div>
<div id="fig0903" class="imageblock">
<div class="content">
<img src="images/ch09/09-03.svg" alt="{full-width}">
</div>
<div class="title">Figure 3. Your daughter can claim your money after the median time past is earlier than your lock time.</div>
</div>
<div class="paragraph">
<p>Your daughter’s transaction can’t be mined in any block before the last
one shown. Before that block, the median time past is too early.</p>
</div>
<div class="paragraph">
<p>Her transaction won’t even propagate through the Bitcoin network until
the lock time has passed. The nodes don’t want to keep time-locked
transactions in their memories because there are better uses for their
precious memory space than to fill them up with transactions that aren’t
even valid (yet). It’s up to your daughter to broadcast the transaction
after the lock time has passed.</p>
</div>
</div>
<div class="sect4">
<h5 id="_block_height">Block height</h5>
<div class="paragraph">
<p>You can also express time using block height. You can say that a
transaction isn’t valid, for example, until after block height 571019.
This means the transaction shown in <a href="#fig0904">A time-locked transaction based on block height. This transaction is first valid at block height 571020.</a> can’t be mined until
after block 571019 has been mined.</p>
</div>
<div id="fig0904" class="imageblock">
<div class="content">
<img src="images/ch09/09-04.svg" alt="{half-width}">
</div>
<div class="title">Figure 4. A time-locked transaction based on block height. This transaction is first valid at block height 571020.</div>
</div>
<div class="paragraph">
<p>The earliest block in which the transaction can be included is at
height 571020. It’s hard to predict exactly when that block will be
mined, but thanks to the difficulty adjustments that keep the average
block time at about 10 minutes, you can expect about 52,596 blocks per
year.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_relative_time_locks">Relative time locks</h4>
<div class="sidebarblock inbitcoin">
<div class="content">
<div class="title">BIP68</div>
<div class="paragraph">
<p>This Bitcoin Improvement Proposal (BIP) describes how an input can
require a certain distance in time or blocks from the spent
transaction output.  It applies to transactions with a version of at
least 2.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The earlier example showed a use case for absolute time locks on
transactions. But you can also lock an input of a transaction until its
spent output is old enough. This is called a <em>relative time lock</em>. You
do this on a per-input basis (<a href="#fig0905">Relative time locks can be expressed either as a number of blocks or as a number of time units. You use the inputs’ sequence numbers for this.</a>).</p>
</div>
<div id="fig0905" class="imageblock">
<div class="content">
<img src="images/ch09/09-05.svg" alt="{full-width}">
</div>
<div class="title">Figure 5. Relative time locks can be expressed either as a number of blocks or as a number of time units. You use the inputs’ sequence numbers for this.</div>
</div>
<div class="paragraph">
<p>The transaction’s first input has a sequence number of <code>004013c6</code>. This
says the transaction isn’t valid until 30 days have passed since the
spent output was confirmed (<a href="#fig0906">The first input locks the transaction for 30 days from the spent output.</a>).</p>
</div>
<div id="fig0906" class="imageblock">
<div class="content">
<img src="images/ch09/09-06.svg" alt="{full-width}">
</div>
<div class="title">Figure 6. The first input locks the transaction for 30 days from the spent output.</div>
</div>
<div class="paragraph">
<p>The leftmost bit of this sequence number is 0, which means the relative
lock time is enabled. The bit at index 9 from the left is 1, which means
the rightmost 16 bits should be interpreted as “number of 512-second
intervals.” The 16 rightmost bits are <code>13c6</code>, which translates to 5,062
in decimal form; 5,062 intervals of 512 seconds is roughly 30 days.</p>
</div>
<div class="paragraph">
<p>The second input has a sequence number of <code>000003e8</code> (<a href="#fig0907">The second input locks the transaction for 1,000 blocks from the spent output.</a>). This
means the transaction is invalid until 1,000 blocks have been mined
since the spent output was mined.</p>
</div>
<div id="fig0907" class="imageblock">
<div class="content">
<img src="images/ch09/09-07.svg" alt="{full-width}">
</div>
<div class="title">Figure 7. The second input locks the transaction for 1,000 blocks from the spent output.</div>
</div>
<div class="paragraph">
<p>The leftmost bit is 0 here, too, which means the relative lock time is
enabled for this input. The bit at index 9 from the left is 0, which
means the 16 rightmost bits should be interpreted as the number of
blocks; <code>03e8</code> is hex code for 1,000.</p>
</div>
<div class="paragraph">
<p>The transaction’s version needs to be at least 2 for relative time
locks to work. If the version is 1, the sequence numbers won’t have
any effect on the relative lock time, but they will affect absolute
lock time and the replace-by-fee feature, which I’ll discuss later in
<a href="#replace-by-fee">Replacing pending transactions</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_time_locked_outputs">Time-locked outputs</h3>
<div class="paragraph">
<p>Time locks aren’t particularly useful in themselves. The only thing you
can do with them is create a transaction that might eventually become
valid.</p>
</div>
<div class="paragraph">
<p>It might be more useful to say something like, “The money in this output
can’t be spent before New Year’s Eve.” This is an example of a
<em>time-locked output</em>. An output can be locked absolutely or
relatively, and locks can be time-based or height-based.</p>
</div>
<div class="sect3">
<h4 id="absolute-time-locked-outputs">Absolute time-locked outputs</h4>
<div class="sidebarblock inbitcoin">
<div class="content">
<div class="title">BIP65</div>
<div class="paragraph">
<p>This BIP describes in detail the script operator <code>OP_CHECKLOCK-</code>
<code>TIMEVERIFY</code>, which implements the absolute time-locked output.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Suppose you want to give your daughter 1 BTC in allowance on 1 May. You
can make a transaction as <a href="#fig0908">Paying allowance in advance to your daughter. She may not spend it before 1 May.</a> shows.</p>
</div>
<div id="fig0908" class="imageblock">
<div class="content">
<img src="images/ch09/09-08.svg" alt="{big-width}">
</div>
<div class="title">Figure 8. Paying allowance in advance to your daughter. She may not spend it before 1 May.</div>
</div>
<div class="sidebarblock inbitcoin">
<div class="content">
<div class="title">“OP_DROP?”</div>
<div class="paragraph">
<p>Using OP_CHECKLOCKTIME VERIFY requires a successive <code>OP_DROP</code> due to
how the operator was deployed in Bitcoin. You’ll learn about that in
<a href="#ch10">[ch10]</a>. Ignore it for now.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>You can broadcast this transaction immediately to the Bitcoin network
and have it mined. The first output is the interesting part. It says
that this output can’t be spent before 1 May. For the curious, the
exact pubkey script is</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;may 1 2019 00:00:00&gt; OP_CHECKLOCKTIMEVERIFY OP_DROP
OP_DUP OP_HASH160 &lt;PKH<sub>D</sub>&gt; OP_EQUALVERIFY OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph">
<p>This script will make sure the transaction spending the output is
sufficiently time-locked, as <a href="#fig0909">Various spending transactions and their validity</a> shows.</p>
</div>
<div id="fig0909" class="imageblock">
<div class="content">
<img src="images/ch09/09-09.svg" alt="{big-width}">
</div>
<div class="title">Figure 9. Various spending transactions and their validity</div>
</div>
<div class="paragraph">
<p>The first two transactions will never be valid because their time locks
aren’t sufficiently late. The first one isn’t locked, which is illegal
according to the pubkey script. The second one is at least time-locked,
but it isn’t late enough—1 second before 1 May is too early.</p>
</div>
<div class="paragraph">
<p>The third transaction is OK because the time lock is at least as high as
the time in the pubkey script, 2019-05-01 00:00:00. This transaction
will be valid on and after 1 May. The last transaction will be valid on
New Year’s Eve, right before the fireworks. Note, however, that you
can’t get both of the last two transactions confirmed—you can get at
most one of them confirmed—because they spend the same output.</p>
</div>
<div class="paragraph">
<p>The result of this example is that your daughter will be able to spend
the output as she pleases after 1 May.</p>
</div>
</div>
<div class="sect3">
<h4 id="_relative_time_locked_outputs">Relative time-locked outputs</h4>
<div class="sidebarblock inbitcoin">
<div class="content">
<div class="title">BIP112</div>
<div class="paragraph">
<p>This BIP describes relative time-locked outputs. The script operator
is called <code>OP_CHECKSEQUENCEVERIFY</code>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>A relative time-locked output works similarly to an absolute
time-locked output, but relative locks require a certain amount of
time to <em>pass</em> between the block containing the spent output and the
block containing the spending transaction (<a href="#fig0910">Spending a relative time-locked output is allowed after a certain number of blocks have passed.</a>).</p>
</div>
<div id="fig0910" class="imageblock">
<div class="content">
<img src="images/ch09/09-10.svg" alt="{big-width}">
</div>
<div class="title">Figure 10. Spending a relative time-locked output is allowed after a certain number of blocks have passed.</div>
</div>
<div class="paragraph">
<p>Relative time locks are most commonly used in <em>digital contracts</em>. A
digital contract can be regarded as a traditional contract between
parties, but it’s enforced by the rules of the Bitcoin network rather
than national laws. Contracts are expressed as Bitcoin pubkey scripts.
We’ll illustrate the use of relative time-locked outputs with an atomic
swap in the next subsection. An atomic swap means two people swap coins
with each other across different cryptocurrencies.</p>
</div>
</div>
<div class="sect3">
<h4 id="_atomic_swaps">Atomic swaps</h4>
<div class="sidebarblock gbinfo">
<div class="content">
<div class="title">Atomic</div>
<div class="paragraph">
<p>In computer science, the word <em>atomic</em> means a process either
completes in its entirety or not at all. For atomic swaps, it means
either the swap completes or both parties get to keep their old
coins. No other outcomes are possible.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>A commonly mentioned digital contract is the <em>atomic swap</em>, where
two parties want to swap coins with each other between different
blockchains.</p>
</div>
<div class="paragraph">
<p>Suppose John is chatting with Fadime on a public forum on the
internet.  They don’t know each other and have no reason to trust one
another. But they both want to trade.</p>
</div>
<div class="paragraph">
<p>They agree that John will trade 2 BTC for 100 of Fadime’s namecoins
(NMC). Namecoin is an alt-coin used as a decentralized naming system,
like DNS. We talked briefly about alt-coins in <a href="ch01-introduction-to-bitcoin.html">[ch01]</a>. It isn’t
important what Namecoin actually is used for in this example; we only
conclude that it’s another cryptocurrency on a blockchain other than
Bitcoin’s.</p>
</div>
<div class="paragraph">
<p>The conversation between John and Fadime starts as follows:</p>
</div>
<div class="paragraph">
<p><strong>John:</strong> Do you want to swap 100 NMC for my 2 BTC? My Namecoin public
key is <code>02381efd…88ca7f23</code>. I’ve created a secret random number that has
the SHA256 hash value H. I will not tell you the secret number yet.</p>
</div>
<div class="paragraph">
<p><strong>Fadime:</strong> Sure John, let’s do it! My Bitcoin public key is
<code>02b0c907…df854ee8</code>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="imageblock">
<div class="content">
<img src="images/ch09/u09-01.svg" alt="u09 01">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We’ll call the secret number S. Only John knows S for now, but he shares
the hash of S—which is H—with Fadime. Now, they both have enough
information to get started.</p>
</div>
<div class="paragraph">
<p>They create one transaction each (<a href="#fig0911">John and Fadime create a contract transaction each. The redeem script of the p2sh output contains the contract details.</a>). John creates a Bitcoin
transaction that spends 2 BTC. Fadime creates a Namecoin transaction
that spends 100 NMC. They don’t broadcast their transactions yet.</p>
</div>
<div id="fig0911" class="imageblock">
<div class="content">
<img src="images/ch09/09-11.svg" alt="{full-width}">
</div>
<div class="title">Figure 11. John and Fadime create a contract transaction each. The redeem script of the p2sh output contains the contract details.</div>
</div>
<div class="paragraph">
<p>The output of John’s contract transaction can be spent in one of two
ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By providing the pre-image of H and Fadime’s signature. John knows this
pre-image—his secret number S from the conversation described
earlier—but Fadime doesn’t.</p>
</li>
<li>
<p>With John’s signature after 48 hours.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Likewise, the output of Fadime’s contract transaction can be spent in
one of two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By providing the pre-image of H and John’s signature</p>
</li>
<li>
<p>With Fadime’s signature after 24 hours</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The relative lock time is enforced by the script operator
<code>OP_CHECKSEQUENCEVERIFY</code>. This operator ensures that the output of
John’s contract transaction can’t be spent by John until 48 hours have
passed since the contract transaction was confirmed. In Fadime’s
contract transaction, the operator ensures that Fadime doesn’t spend
the output until after 24 hours.</p>
</div>
<div class="paragraph">
<p>Fadime knows John has the secret number. If Fadime broadcasts her
contract transaction now, John can take the money and not fulfill his
part of the deal. For this reason, she won’t broadcast her transaction
until she’s seen John’s transaction safely confirmed in the
blockchain.  Because Fadime doesn’t know the secret, S, John can
safely broadcast his contract transaction without Fadime running away
with the money.</p>
</div>
<div class="sidebarblock bigside">
<div class="content">
<div class="imageblock">
<div class="content">
<img src="images/ch09/u09-02.svg" alt="u09 02">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>John broadcasts his contract transaction. Remember that the output of
the contract transaction in this example is a pay-to-script-hash
(p2sh) output. The output contains a p2sh address that doesn’t say
anything about this being John’s contract output. For Fadime to
identify John’s contract transaction on the Bitcoin blockchain, she’ll
construct the same redeem script as John created for his contract
transaction and generate the p2sh address that John’s contract
transaction paid to. She can then look for that p2sh address in the
Bitcoin blockchain.</p>
</div>
<div class="paragraph">
<p>When Fadime finds that John’s transaction is confirmed, she broadcasts
her own contract transaction. John waits until Fadime’s transaction is
sufficiently confirmed on the Namecoin blockchain. Then, the actual
swap happens in two steps. <a href="#fig0912">The first step of the actual swap. John claims Fadime’s 100 NMC by revealing the secret S.</a> shows the first step.</p>
</div>
<div id="fig0912" class="imageblock">
<div class="content">
<img src="images/ch09/09-12.svg" alt="{full-width}">
</div>
<div class="title">Figure 12. The first step of the actual swap. John claims Fadime’s 100 NMC by revealing the secret S.</div>
</div>
<div class="paragraph">
<p>John broadcasts his swap transaction. John’s swap transaction spends
Fadime’s contract transaction output by providing S and his signature.
Again, note that John is spending a p2sh output. This means the first
thing that happens during script validation is that the redeem script
John provided in the signature script will be hashed and compared to the
hash in the pubkey script. The actual redeem script will then be run.</p>
</div>
<div class="paragraph">
<p>We won’t go through the program in detail. But when the redeem script
starts running, the stack will have <code>1</code> on top. This means <code>true</code> in
Namecoin, just as in Bitcoin. This value will cause the program to run
the part of the script that requires a pre-image and John’s signature.
The other part isn’t run at all.</p>
</div>
<div class="paragraph">
<p>The script will leave the stack with a <code>true</code> on top because John
provides both required items in the correct order—his signature and the
pre-image, <code>S</code>. He successfully claims his 100 NMC.</p>
</div>
<div class="paragraph">
<p>As soon as Fadime sees John’s swap transaction on the Namecoin network,
she can create her own swap transaction for the Bitcoin blockchain
(<a href="#fig0913">Fadime completes the atomic swap by sending her swap transaction to the Bitcoin network.</a>).</p>
</div>
<div id="fig0913" class="imageblock">
<div class="content">
<img src="images/ch09/09-13.svg" alt="{full-width}">
</div>
<div class="title">Figure 13. Fadime completes the atomic swap by sending her swap transaction to the Bitcoin network.</div>
</div>
<div class="paragraph">
<p>She takes the pre-image, S, from John’s swap transaction and puts it
into her own swap transaction, which pays 2 BTC to Fadime’s public key
hash, PKH<sub>F</sub>. When the two swap transactions are confirmed, the atomic
swap is complete. The effect of all this is that John has sent 2 BTC to
Fadime under the condition that Fadime sends 100 NMC to him, and Fadime
sends 100 NMC to John under the condition that John sends<br>
2 BTC to her.</p>
</div>
<div class="sect4">
<h5 id="_atomic_swap_failure">Atomic swap failure</h5>
<div class="paragraph">
<p>The sequence of events in this atomic swap example illustrates a case in
which both parties, John and Fadime, play by the rules. No one had to
actually use the time-locked branches of the contract transaction
outputs. This subsection will go through some ways the swap might fail:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Fadime doesn’t broadcast her contract transaction.</dt>
<dd>
<p>This means John
can’t spend the output of Fadime’s contract transaction, which means
Fadime will never get to see S. Without S, she can’t spend John’s
contract output. The only possible outcome is that John must wait 48
hours for the relative time lock to pass and then reclaim his money.</p>
</dd>
<dt class="hdlist1">John doesn’t spend Fadime’s contract output in 24 hours.</dt>
<dd>
<p>Fadime can
reclaim her coins, and John must wait another 24 hours before claiming
his coins back.</p>
</dd>
<dt class="hdlist1">John spends Fadime’s contract output just after 24 hours has passed but before Fadime claims back her coins.</dt>
<dd>
<p>Fortunately, John’s
contract output has a 48-hour relative lock time as opposed to the 24
hours in Fadime’s contract output, so John can’t claim his coins back
until he’s waited another 24 hours. During this time, Fadime can claim
her BTC from John’s contract output using S and her signature.</p>
</dd>
<dt class="hdlist1">Fadime gets hit by a bus just after broadcasting her contract output.</dt>
<dd>
<p>This is no good. John will be able to take his NMC from Fadime’s
contract output and then wait 48 hours to also claim back his BTC.
Fadime loses out on this one.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In the final case, we could argue that the swap wasn’t atomic. After
all, it didn’t go through, and John ended up with all the coins. This
is a somewhat philosophical question. But we can think of swaps as
being atomic under the condition that Fadime can take action. We don’t
have this condition for John, though. It’s a matter of who creates the
secret, S.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_storing_stuff_in_the_bitcoin_blockchain">Storing stuff in the Bitcoin blockchain</h3>
<div class="paragraph">
<p>In the early days of Bitcoin, it became clear that people wanted to
put stuff in transactions in the Bitcoin blockchain that didn’t have
anything to do with Bitcoin itself: for example, <a href="#lis0901">A tribute in a transaction</a>, which is
a blockchain tribute to cryptographer Sassama, allegedly posted by Dan
Kaminsky. (The message is wrapped into three columns here to save
space.)</p>
</div>
<div id="lis0901" class="listingblock">
<div class="title">A tribute in a transaction</div>
<div class="content">
<pre>---BEGIN TRIBUTE---     LEN "rabbi" SASSAMA     P.S.  My apologies,
#./BitLen                    1980-2011          BitCoin people.  He
:::::::::::::::::::     Len was our friend.     also would have
:::::::.::.::.:.:::     A brilliant mind,       LOL'd at BitCoin's
:.: :.' ' ' ' ' : :     a kind soul, and        new dependency upon
:.:'' ,,xiW,"4x, ''     a devious schemer;         ASCII BERNANKE
:  ,dWWWXXXXi,4WX,      husband to Meredith     :'::.:::::.:::.::.:
' dWWWXXX7"     `X,     brother to Calvin,      : :.: ' ' ' ' : :':
 lWWWXX7   __   _ X     son to Jim and          :.:     _.__    '.:
:WWWXX7 ,xXX7' "^^X     Dana Hartshorn,         :   _,^"   "^x,   :
lWWWX7, _.+,, _.+.,     coauthor and            '  x7'        `4,
:WWW7,. `^"-" ,^-'      cofounder and            XX7            4XX
 WW",X:        X,       Shmoo and so much        XX              XX
 "7^^Xl.    _(_x7'      more.  We dedicate       Xl ,xxx,   ,xxx,XX
 l ( :X:       __ _     this silly hack to      ( ' _,+o, | ,o+,"
 `. " XX  ,xxWWWWX7     Len, who would have      4   "-^' X "^-'" 7
  )X- "" 4X" .___.      found it absolutely      l,     ( ))     ,X
,W X     :Xi  _,,_      hilarious.               :Xx,_ ,xXXXxx,_,XX
WW X      4XiyXWWXd     --Dan Kaminsky,           4XXiX'-___-`XXXX'
"" ,,      4XWWWWXX     Travis Goodspeed           4XXi,_   _iXX7'
, R7X,       "^447^                               , `4XXXXXXXXX^ _,
R, "4RXk,      _, ,                               Xx,  ""^^^XX7,xX
TWk  "4RXXi,   X',x                             W,"4WWx,_ _,XxWWX7'
lTWk,  "4RRR7' 4 XH                             Xwi, "4WW7""4WW7',W
:lWWWk,  ^"     `4                              TXXWw, ^7 Xk 47 ,WH
::TTXWWi,_  Xll :..                             :TXXXWw,_ "), ,wWT:
=-=-=-=-=-=-=-=-=-=                             ::TTXXWWW lXl WWT:
                                                ----END TRIBUTE----</pre>
</div>
</div>
<div class="paragraph">
<p>Although this was certainly interesting and funny, it had some
implications for Bitcoin’s full nodes.</p>
</div>
<div class="paragraph">
<p>The message in <a href="#lis0901">A tribute in a transaction</a> was written into the blockchain using a
single transaction with txid</p>
</div>
<div class="literalblock">
<div class="content">
<pre>930a2114cdaa86e1fac46d15c74e81c09eee1d4150ff9d48e76cb0697d8e1d72</pre>
</div>
</div>
<div class="sidebarblock gbinfo">
<div class="content">
<div class="title">Blockchain explorer</div>
<div class="paragraph">
<p>You can take a closer look at this transaction using a blockchain
explorer, such as the one at <a href="#web-bernanke-ascii-art">[web-bernanke-ascii-art]</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The author created a transaction with 78 outputs, one for each
20-character line in the message. Each line ends with a space, so only
19 characters are visible.</p>
</div>
<div class="paragraph">
<p>For example, the last output’s pubkey script looks like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>OP_DUP OP_HASH160 2d2d2d2d454e4420545249425554452d2d2d2d20 OP_EQUALVERIFY OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph">
<p>The interesting part is the PKH. This isn’t an actual PKH, but a made-up
one. Maybe you can see a pattern when you compare it to the line
“<code>----END TRIBUTE---- </code>”:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>2d 2d 2d 2d 45 4e 44 20 54 52 49 42 55 54 45 2d 2d 2d 2d 20
-  -  -  -  E  N  D     T  R  I  B  U  T  E  -  -  -  -</pre>
</div>
</div>
<div class="paragraph">
<p>This “public key hash” encodes one 20-character line in the
message. It uses the <em>ASCII table</em> to encode characters. For example,
the character <code>-</code> is encoded as the byte <code>2d</code>. The characters A–Z are
encoded by the bytes <code>41</code>–<code>5a</code>, and a space is encoded as byte <code>20</code>.</p>
</div>
<div class="paragraph">
<p>Let’s look at the PKHs of the message’s last 10 lines along with the
ASCII-decoded text:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>20203458586958272d5f5f5f2d60585858582720   4XXiX'-___-`XXXX'
202020345858692c5f2020205f69585837272020    4XXi,_   _iXX7'
20202c2060345858585858585858585e205f2c20   , `4XXXXXXXXX^ _,
202058782c202022225e5e5e5858372c78582020   Xx,  ""^^^XX7,xX
572c22345757782c5f205f2c5878575758372720 W,"4WWx,_ _,XxWWX7'
5877692c202234575737222234575737272c5720 Xwi, "4WW7""4WW7',W
54585857772c205e3720586b203437202c574820 TXXWw, ^7 Xk 47 ,WH
3a5458585857772c5f2022292c202c7757543a20 :TXXXWw,_ "), ,wWT:
3a3a54545858575757206c586c205757543a2020 ::TTXXWWW lXl WWT:
2d2d2d2d454e4420545249425554452d2d2d2d20 ----END TRIBUTE----</pre>
</div>
</div>
<div class="sect3">
<h4 id="_bloated_utxo_set">Bloated UTXO set</h4>
<div class="sidebarblock bigside">
<div class="content">
<div class="imageblock">
<div class="content">
<img src="images/ch09/u09-03.svg" alt="u09 03">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Because these PKHs are made up, they have no known pre-images. This also
means no known public/private key pairs are associated with them, so no
one can ever spend the outputs. They’re <em>unspendable</em>. The last PKH’s
Bitcoin address is <code>157sXYpj…QnHB6FGU</code>. Anyone who pays money to this
address is throwing that money in the trash. The money is lost forever.
It’s the equivalent of burning a dollar bill.</p>
</div>
<div class="paragraph">
<p>Unspendable outputs like these are indistinguishable from ordinary,
spendable outputs. You can’t prove that they’re unspendable. Full nodes
have to treat them as spendable, meaning they have to keep these
unspendable outputs in their unspent transaction output (UTXO) set
forever. This places an unnecessary burden on nodes, which need to keep
all these outputs in memory.</p>
</div>
<div class="paragraph">
<p>Bitcoin’s developers came up with a partial solution to this problem.
Instead of sending money to unprovably unspendable outputs, users can
create <em>provably unspendable</em> outputs. If a full node can determine if
an output is unspendable,<br>
it doesn’t have to insert that output into its UTXO set.</p>
</div>
<div class="paragraph">
<p>The partial solution involves a new script operator called <code>OP_RETURN</code>.
This operator immediately fails when executed. A typical <code>OP_RETURN</code>
pubkey script can look like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>OP_RETURN "I'm Grokking Bitcoin"</pre>
</div>
</div>
<div class="paragraph">
<p>If someone tried to spend this output, the script would fail once it
encountered the <code>OP_RETURN</code>. If the pubkey script contains this
operator, a full node can determine that the output isn’t spendable and
ignore it, saving the UTXO set from being forever bloated with this
nonsense. A typical <code>OP_RETURN</code> output pays 0 BTC, but it can also set a
value greater than 0 to “burn” money.</p>
</div>
<div class="paragraph">
<p>There are a few policies regarding <code>OP_RETURN</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The full pubkey script must not be bigger than 83 bytes.</p>
</li>
<li>
<p>There can be only one <code>OP_RETURN</code> output per transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These two policies are just that—policies. Full nodes adhering to
these policies won’t relay transactions that violate them. But if they
encounter a block that contains transactions that violate the
policies, the block will be accepted and relayed. I’ll talk more about
policies and <em>consensus rules</em>, strict rules that apply to blocks,
in <a href="#ch10">[ch10]</a> and <a href="#ch11">[ch11]</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_token_in_bitcoin">Creating a token in Bitcoin</h4>
<div class="paragraph">
<p>I talked briefly about tracking ownership on the blockchain in
<a href="ch01-introduction-to-bitcoin.html">[ch01]</a>. Suppose a car manufacturer, let’s call it Ampere, decides
that it wants to digitally track the ownership of its cars on the
Bitcoin blockchain. This can be accomplished by creating a token in
Bitcoin.</p>
</div>
<div class="paragraph">
<p>Suppose Ampere wants to create a token for a newly manufactured car with
chassis number 123456. It broadcasts a Bitcoin transaction as shown in
<a href="#fig0914">Ampere creates a new token for a newly built car. It issues the token to itself because it still owns this car.</a>.</p>
</div>
<div id="fig0914" class="imageblock">
<div class="content">
<img src="images/ch09/09-14.svg" alt="{big-width}">
</div>
<div class="title">Figure 14. Ampere creates a new token for a newly built car. It issues the token to itself because it still owns this car.</div>
</div>
<div class="paragraph">
<p>This “Ampere token protocol” specifies that a new token is created when</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ampere spends a coin from PKH<sub>A</sub>.</p>
</li>
<li>
<p>The transaction contains an <code>OP_RETURN</code> output with the text
<code>"ampere &lt;chassis number&gt;"</code>.</p>
</li>
<li>
<p>The first output is the initial token owner.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ampere has a well-known web page at <a href="https://www.ampere.example.com" class="bare">https://www.ampere.example.com</a>,
where it has published its public key corresponding to PKH<sub>A</sub>. It also
pumps out its public key through advertisements and via Facebook and
Twitter. It does all this so people can verify that PKH<sub>A</sub> actually
belongs to Ampere.</p>
</div>
<div class="paragraph">
<p>Suppose Ampere sells this car to a car dealer. The dealer has a public
key hash, PKH<sub>D</sub>. <a href="#fig0915">Ampere sells the car to a car dealer with public key hash PKH<sub>D</sub>.</a> shows how Ampere will transfer digital
ownership to the dealer.</p>
</div>
<div id="fig0915" class="imageblock">
<div class="content">
<img src="images/ch09/09-15.svg" alt="{full-width}">
</div>
<div class="title">Figure 15. Ampere sells the car to a car dealer with public key hash PKH<sub>D</sub>.</div>
</div>
<div class="paragraph">
<p>According to our simple protocol, car ownership is transferred by
spending the old owner’s output. The following rules apply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The spending transaction spends the old owner’s output.</p>
</li>
<li>
<p>The first output of the spending transaction is the new owner of
the car.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The car dealer is now the new owner because PKH<sub>D</sub> is the first output
of the spending transaction. That’s it. When the dealer sells this car
to a consumer, Fadime, it transfers the car’s ownership to Fadime’s
address, PKH<sub>F</sub> (<a href="#fig0916">The car dealer transfers the car’s ownership to Fadime’s PKH<sub>F</sub>.</a>).</p>
</div>
<div id="fig0916" class="imageblock">
<div class="content">
<img src="images/ch09/09-16.svg" alt="{full-width}">
</div>
<div class="title">Figure 16. The car dealer transfers the car’s ownership to Fadime’s PKH<sub>F</sub>.</div>
</div>
</div>
<div class="sect3">
<h4 id="_starting_the_car_with_proof_of_ownership">Starting the car with proof of ownership</h4>
<div class="paragraph">
<p>Now that Fadime is the rightful owner of this car, wouldn’t it be cool
if she could start it by proving she’s the owner? She can. The car is
equipped with an ignition lock that starts the engine when Fadime sends
a proof of ownership to the car (<a href="#fig0917">Fadime starts her car by signing a challenge with her private key.</a>).</p>
</div>
<div id="fig0917" class="imageblock">
<div class="content">
<img src="images/ch09/09-17.svg" alt="{big-width}">
</div>
<div class="title">Figure 17. Fadime starts her car by signing a challenge with her private key.</div>
</div>
<div class="paragraph">
<p>Fadime first asks the car to start. The car won’t start if it doesn’t
know that Fadime has the private key belonging to PKH<sub>F</sub>. The car
generates a big random number and sends it to Fadime, who signs this
random number with the private key and sends the signature and her
public key to the car.</p>
</div>
<div class="paragraph">
<p>The car needs the public key to verify that it corresponds to PKH<sub>F</sub> as
written in the blockchain. The car keeps track of who currently owns it
by running a lightweight wallet that understands the Ampere token
protocol.</p>
</div>
<div class="paragraph">
<p>When the car has verified that the signature is valid and from the
correct private key, it will start the engine.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="replace-by-fee">Replacing pending transactions</h3>
<div class="paragraph">
<p>When you send a Bitcoin transaction to buy a book online, the bookstore
will wait for the transaction to confirm before it sends the book to
you. Usually, your transaction will be confirmed within an hour or so,
but what if it isn’t? What if no miner ever wants to include your
transaction? This can certainly happen if your transaction fee isn’t
sufficient (<a href="#fig0918">You pay for your book and set the transaction fee to 0.00001 BTC.</a>).</p>
</div>
<div id="fig0918" class="imageblock">
<div class="content">
<img src="images/ch09/09-18.svg" alt="{big-width}">
</div>
<div class="title">Figure 18. You pay for your book and set the transaction fee to 0.00001 BTC.</div>
</div>
<div class="paragraph">
<p>You might recall from <a href="#transaction-fees">[transaction-fees]</a> that the
transaction fee is the sum of the input values minus the sum of the
output values. The fee per byte that miners care about is calculated by
dividing that fee by the transaction’s size—in this case, 1,000 satoshis
divided by 226 bytes, which is about 4.4 sat/byte.</p>
</div>
<div class="paragraph">
<p>If no miner is willing to include the transaction for that fee, your
transaction will be stuck waiting for confirmation. If the transaction
isn’t confirmed, you won’t get your book. You probably want to do
something about this situation. Maybe you can create a new, similar
transaction, but with a higher fee. Let’s try (<a href="#fig0919">You try to replace your old, stuck transaction with a new one with a higher fee.</a>).</p>
</div>
<div id="fig0919" class="imageblock">
<div class="content">
<img src="images/ch09/09-19.svg" alt="{big-width}">
</div>
<div class="title">Figure 19. You try to replace your old, stuck transaction with a new one with a higher fee.</div>
</div>
<div class="paragraph">
<p>That’s nice: you’ve created and signed a new transaction with a fee 20
times higher. This will surely get mined, you think, and broadcast the
transaction.</p>
</div>
<div class="paragraph">
<p>The problem is that your new transaction will probably be regarded as a
double-spend attempt and be dropped by most nodes. They’ll think the
first transaction is the one that counts, and they’ll disregard any
further transactions that spend the same output. How to handle the
second transaction is completely up to the nodes, but the most common
policy is to drop it. This is what Bitcoin Core does, and that’s the
most widely used Bitcoin software. This policy is known as the
<em>first-seen policy</em>.</p>
</div>
<div class="sidebarblock gbinfo">
<div class="content">
<div class="title">Hint for exercises</div>
<div class="paragraph">
<p>Keep this in mind for <a href="#exercise-rbf">Exercise 11</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>You might be able to circumvent this policy by sending the second
transaction directly to one or more miners. Miners have different
incentives than full nodes. Mining full nodes want to earn
rewards—subsidy + fees—by providing proof of work to the blockchain,
whereas non-mining full nodes want to keep their memory and computing
resource consumption down. If a miner could get hold of the second,
high-fee transaction, it would probably decide to include it despite
the fact that the low-fee transaction was the first seen. Replacing
transactions in this way is impractical because you don’t know any
miners’ IP addresses unless they’re published somehow. You also reveal
your IP address to the miners, and the miners then become targets for
various surveillance organizations or companies wanting to monetize
information about you.</p>
</div>
<div class="sect3">
<h4 id="_opt_in_replace_by_fee">Opt-in replace-by-fee</h4>
<div class="sidebarblock inbitcoin">
<div class="content">
<div class="title">BIP125</div>
<div class="paragraph">
<p>This BIP describes how transactions can declare themselves
replaceable.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>In 2016, a policy was deployed for transaction replacement. It’s
generally called <em>opt-in replace-by-fee</em>, or opt-in RBF
(<a href="#fig0920">Use opt-in RBF to easily replace a transaction before it’s confirmed.</a>). It works by using the sequence numbers of a
transaction’s inputs.</p>
</div>
<div id="fig0920" class="imageblock">
<div class="content">
<img src="images/ch09/09-20.svg" alt="{big-width}">
</div>
<div class="title">Figure 20. Use opt-in RBF to easily replace a transaction before it’s confirmed.</div>
</div>
<div class="paragraph">
<p>Suppose again that you want to pay for a book in an online bookstore.
When you create the transaction, you make sure one of the inputs
(there’s only one in this example) has a sequence number less than
<code>fffffffe</code>. This signals to nodes that you want this transaction to be
replaceable.</p>
</div>
<div class="paragraph">
<p>When a node receives this transaction, it will be treated as a normal
transaction, but the replaceability will be remembered.</p>
</div>
<div class="paragraph">
<p>When you later notice that your transaction doesn’t confirm because of a
too-low fee, you can create a new, replacement transaction with a higher
fee. When you broadcast the replacement transaction, the nodes receiving
it will—if they implement the opt-in RBF policy—kindly replace the old
transaction with the new one and relay the new one to their peers. The
old transaction will be dropped. This way, the replacement transaction
will eventually reach all nodes, including miners, and will hopefully be
confirmed within a reasonable time.</p>
</div>
<div class="paragraph">
<p>In this example, you set the sequence number of the replacement
transaction’s input to <code>ffffffff</code>. This means the replacement
transaction is not itself replaceable. If you want the replacement
transaction to also be replaceable, you must set its sequence number to
<code>fffffffd</code> or less, just as you did with the replaced transaction.</p>
</div>
<div class="paragraph">
<p>You might be wondering where these sequence numbers come from. The
intention with sequence numbers from the beginning was to allow for
another kind of transaction replacement. The feature was disabled early
in Bitcoin, but the sequence numbers remained in the transaction inputs.
These sequence numbers have since been repurposed for absolute lock
time, relative lock time, and replace-by-fee, as described throughout
this chapter. If you feel confused, don’t worry; I’ll summarize the
different uses of sequence numbers in <a href="#ch09-recap">Recap</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_child_pays_for_parent">Child pays for parent</h4>
<div class="paragraph">
<p>There is yet another way to bump up a fee. Suppose you have the
situation depicted earlier in <a href="#fig0918">You pay for your book and set the transaction fee to 0.00001 BTC.</a>, and you notice that this
transaction gets stuck (<a href="#fig0921">You haven’t paid a sufficient transaction fee. The transaction is stuck pending because miners don’t want to include it in a block.</a>).</p>
</div>
<div id="fig0921" class="imageblock">
<div class="content">
<img src="images/ch09/09-21.svg" alt="{big-width}">
</div>
<div class="title">Figure 21. You haven’t paid a sufficient transaction fee. The transaction is stuck pending because miners don’t want to include it in a block.</div>
</div>
<div class="paragraph">
<p>You can make another transaction that spends your change and pays an
extra-high fee to compensate for the low fee in the original
transaction (<a href="#fig0922">Spending your change and paying an extra fee for the “parent” transaction</a>).</p>
</div>
<div id="fig0922" class="imageblock">
<div class="content">
<img src="images/ch09/09-22.svg" alt="{full-width}">
</div>
<div class="title">Figure 22. Spending your change and paying an extra fee for the “parent” transaction</div>
</div>
<div class="paragraph">
<p>Suppose a miner sees these two transactions. If the miner wants to
collect the fee from the child transaction, it has to include both the
parent and the child transactions. If it tries to include only the
child transaction, the block won’t be valid because the child
transaction spends money that doesn’t exist in the blockchain.</p>
</div>
<div class="paragraph">
<p>Both you and the bookstore can perform this trick. If you don’t bump
the fee, the bookstore can spend its output of 10 BTC and pay itself
9.9998 BTC to add 0.0002 BTC to the combined fee.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sighash-types">Different signature types</h3>
<div class="paragraph">
<p>When you sign a typical Bitcoin transaction, you sign the entire
transaction, excluding the signature script (<a href="#fig0923">Normally, the entire transaction is signed. All inputs and all outputs are covered.</a>).</p>
</div>
<div id="fig0923" class="imageblock">
<div class="content">
<img src="images/ch09/09-23.svg" alt="{half-width}">
</div>
<div class="title">Figure 23. Normally, the entire transaction is signed. All inputs and all outputs are covered.</div>
</div>
<div class="paragraph">
<p>This transaction contains two inputs, and each input signs the complete
transaction. A signature <em>commits to</em> all inputs and all outputs. If any
of the inputs or outputs change, the signature will become invalid.</p>
</div>
<div class="paragraph">
<p>You can change this signature behavior using a parameter in the
signature called the <code>SIGHASH</code> type. You can commit to outputs in three
ways (<code>ALL</code>, <code>SINGLE</code>, and <code>NONE</code>) and to inputs in two ways
(<code>ANYONECANPAY</code> set or not set). Any combination of an input <code>SIGHASH</code>
type and an output <code>SIGHASH</code> type can be used, which makes six different
combinations, as <a href="#fig0924">A signature can commit to different parts of the transaction depending on the <code>SIGHASH</code> types. The signature doesn’t include the grayed-out parts.</a> shows.</p>
</div>
<div id="fig0924" class="imageblock">
<div class="content">
<img src="images/ch09/09-24.svg" alt="{big-width}">
</div>
<div class="title">Figure 24. A signature can commit to different parts of the transaction depending on the <code>SIGHASH</code> types. The signature doesn’t include the grayed-out parts.</div>
</div>
<div class="paragraph">
<p>For the outputs, you can commit to the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>All outputs (<code>ALL</code>)</em>—No one gets to change any outputs.</p>
</li>
<li>
<p><em>A single output at the same index as the input (<code>SINGLE</code>)</em>—You
only care about the specific output. The other outputs can change.</p>
</li>
<li>
<p><em>No outputs (<code>NONE</code>)</em>—You don’t care where the money goes. Anyone
can add any outputs without invalidating your signature.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the inputs, you can commit as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>All inputs (<code>ANYONECANPAY</code> is not set)</em>—No one can change any
input without invalidating your signature.</p>
</li>
<li>
<p><em>Only the current input (<code>ANYONECANPAY</code> is set)</em>—Other inputs
might be changed, removed, or added. You don’t care who pays. Anyone can
pay.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the vast majority of signatures, <code>ALL</code> combined with an unset
<code>ANYONECANPAY</code> is used to commit to the whole transaction. This is what
you’re used to from the earlier chapters in this book. Other types are
rare and are used primarily for specialized digital contracts.</p>
</div>
</div>
<div class="sect2">
<h3 id="ch09-recap">Recap</h3>
<div class="paragraph">
<p>This chapter has been a potpourri of things you can do with
transactions.</p>
</div>
<div class="paragraph">
<p>Transactions and transaction outputs can be time-locked in different
ways to prevent funds from being spent until a certain date or time span
has occurred, as the following table shows.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Action</th>
<th class="tableblock halign-left valign-top">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the lock time of a transaction.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction won’t be valid until a certain time or block height.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the relative time lock on an input using the sequence number.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction won’t be valid until a certain amount of time or
number of blocks have passed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>OP_CHECKLOCKTIMEVERIFY</code> in a pubkey script.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The output can’t be spent until a certain time or block height.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>OP_CHECKSEQUENCEVERIFY</code> in a pubkey script.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The output can’t be spent until a certain amount of time or number
of blocks have passed.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All these variants can be expressed in either block height or time. Time
locks are useful mostly in digital contracts, such as atomic swaps. An
atomic swap lets people who don’t trust each other swap coins without
using a trusted third party.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ch09/u09-04.svg" alt="{full-width}">
</div>
</div>
<div class="paragraph">
<p>The general idea is that John must reveal the secret, S, to claim his
coins. Fadime can then use S to claim her coins.</p>
</div>
<div class="paragraph">
<p>Arbitrary data can be stored in <code>OP_RETURN</code> outputs without placing a
burden on nodes’ UTXO sets. You can use this to create tokens. For
example, the ownership of a car can be tracked and verified on the
Bitcoin blockchain.</p>
</div>
<div class="paragraph">
<p>A transaction can sometimes get stuck in a pending state because no
miners want to include it in their blocks. This usually happens
because you’ve paid a too-small fee. To prepare for this situation,
you can mark the transaction as replaceable by setting the sequence
number of at least one input to a value lower than <code>fffffffe</code>. If that
transaction gets stuck, you can bump the the fee by broadcasting a
replacement transaction that pays a higher fee.</p>
</div>
<div class="paragraph">
<p>Inputs’ sequence numbers are used for various purposes. We’ve
discussed many different uses for sequence numbers in this chapter,
and it’s hard to keep track of them. <a href="#tab0901">Sequence numbers are used to enable or disable various features. <span class="big">✔</span>=enabled, <span class="big">✘</span>=disabled. *Tx version 2 required.</a> summarizes the meaning
of different sequence number values.</p>
</div>
<table id="tab0901" class="tableblock frame-all grid-all spread widetable">
<caption class="title">Table 1. Sequence numbers are used to enable or disable various features. <span class="big">✔</span>=enabled, <span class="big">✘</span>=disabled. *Tx version 2 required.</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sequence value</th>
<th class="tableblock halign-left valign-top">Lock time, any input</th>
<th class="tableblock halign-left valign-top">Replace-by-fee (BIP125), any input</th>
<th class="tableblock halign-left valign-top">Relative lock time on input (BIP68)*</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>00000000</code>-<code>7fffffff</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="big">✔</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="big">✔</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="big">✔</span></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>80000000</code>-<code>fffffffd</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="big">✔</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="big">✔</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="big">✘</span></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>fffffffe</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="big">✔</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="big">✘</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="big">✘</span></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>ffffffff</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="big">✘</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="big">✘</span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="big">✘</span></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_exercises">Exercises</h3>
<div class="sect3">
<h4 id="_warm_up">Warm up</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>What’s required from a transaction’s inputs to enable absolute
lock time?</p>
</li>
<li>
<p>Suppose a transaction is time-locked (absolute) to 25 December
2019 00:00:00. How does a miner check whether the transaction is OK to
put in a block?</p>
</li>
<li>
<p>Where is the relative lock time of an input located?</p>
</li>
<li>
<p>Suppose Adam and Eve want to swap coins with each other using an
atomic swap. How many transactions would be created on each blockchain
upon completion?</p>
</li>
<li>
<p>Why is it bad for the UTXO set to store arbitrary data such as
“HELLO WORLD” as fake PKHs in outputs as opposed to storing them in
<code>OP_RETURN</code> outputs?</p>
</li>
<li>
<p>Why would you want to replace a broadcast transaction that isn’t
confirmed yet?</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_dig_in">Dig in</h4>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>Explain the differences between absolute lock time and relative
lock time.</p>
</li>
<li>
<p>(This exercise is hard; feel free to skip it.) Suppose you want to
bet 1 BTC that it’s going to snow in London on Christmas Eve, and Ruth
bets 1 BTC that it’s not. You appoint a person, Beth, whom you both
trust to solve any conflicts that might occur. You and Ruth
collaborate to create and broadcast a transaction that spends 1 BTC
each to an output of 2 BTC with the following redeem script. (The
redeem script <em>can</em> be made smaller, but to make it simpler to read, I
used a slightly bigger version.) Explain how the redeem script works
on a conceptual level.</p>
<div class="imageblock">
<div class="content">
<img src="images/ch09/u09-05.svg" alt="{full-width}">
</div>
</div>
</li>
<li>
<p>If a p2sh output pays to the hash of a redeem script that consists
solely of an <code>OP_RETURN</code> with 32 random bytes, would full nodes be
able to know that the output is unspendable?</p>
<div class="literalblock">
<div class="content">
<pre>OP_RETURN 53a1e411…b4e6d949</pre>
</div>
</div>
</li>
<li>
<p>Explain how the first-seen policy works. Also, are nodes obliged to
follow the policy?</p>
</li>
</ol>
</div>
<div id="exercise-rbf" class="olist arabic">
<ol class="arabic" start="11">
<li>
<p>Opt-in RBF offers a method for transaction replacement. Is
there any fundamental security difference between a transaction with
opt-in RBF enabled and a transaction that doesn’t opt in? Explain your
reasoning.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary">Summary</h3>
<div class="ulist">
<ul>
<li>
<p>Transactions can be locked with respect to time or block height
depending on your application needs. The locks can be either absolute
or relative.</p>
</li>
<li>
<p>A transaction output can require the spending transaction to be
time-locked. This is useful in many digital contracts.</p>
</li>
<li>
<p>Atomic swaps are a useful way to exchange cryptocurrencies between
two parties that don’t trust each other.</p>
</li>
<li>
<p>Arbitrary data—for example, a car ownership token—can be stored in
<code>OP_RETURN</code> outputs without burdening the UTXO set.</p>
</li>
<li>
<p>A transaction can be marked replaceable. This lets you replace the
transaction in case it doesn’t confirm within a reasonable time.</p>
</li>
<li>
<p>Signatures can commit to different parts of the transaction using
six combinations of <code>SIGHASH</code> types. This can be handy in certain
digital contracts.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-01-26 11:15:39 +06
</div>
</div>
</body>
</html>
